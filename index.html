<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cloning Survey Research Project — Master</title>

  <!-- Chart.js v4 -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
  /* -------------------------
     MASTER STYLES
     ------------------------- */
  :root{
    --bg:#051018; --panel:#0d1b26; --card:#07121a; --muted:#9fb1c7; --text:#eaf6ff;
    --accent:#39d0ff; --accent2:#7affb2; --accent3:#ff7ab6; --warn:#ffb347;
    --vblue:#53a7ff; --vpink:#ff5894; --vgreen:#6aff8f; --vyellow:#ffe66a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background:linear-gradient(180deg,#02040a 0%,#071018 100%); color:var(--text); -webkit-font-smoothing:antialiased;
  }
  .container{ max-width:1200px; margin:18px auto; padding:18px; }

  /* Header */
  header{ position:sticky; top:0; z-index:999; background:linear-gradient(90deg,#07121a,#081822); padding:10px 14px; border-bottom:1px solid rgba(255,255,255,0.03); }
  .header-inner{ display:flex; align-items:center; justify-content:space-between; gap:12px; max-width:1200px; margin:auto; }
  .brand{ font-weight:800; font-size:18px; }
  .signature{ color:var(--muted); font-size:13px; }

  /* Tabs */
  .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
  .tab{ padding:8px 12px; border-radius:10px; background:transparent; color:var(--muted); cursor:pointer; border:1px solid rgba(255,255,255,0.02); transition:transform .12s, box-shadow .12s; }
  .tab:hover{ transform:translateY(-2px); }
  .tab.active{ background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#042; box-shadow:0 10px 30px rgba(57,208,255,0.06); }

  /* Sections and cards */
  .section{ padding:20px 12px; margin-top:18px; }
  .card{ background:linear-gradient(180deg, rgba(255,255,255,0.015), transparent); border:1px solid rgba(255,255,255,0.03); padding:18px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.6); }
  h1,h2,h3{ margin:0 0 12px 0; }
  h2{ font-size:1.2rem; color:var(--accent2); }
  p,li{ color:var(--muted); font-size:15px; }

  /* Side-by-side layout for charts & analysis */
  .ss-row{ display:flex; gap:20px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap; }
  .ss-left{ flex: 1 1 58%; min-width:320px; }
  .ss-right{ flex: 0 0 36%; min-width:260px; max-width:360px; }

  /* Chart container */
  .chart-card{ background:rgba(255,255,255,0.02); padding:14px; border-radius:12px; border:1px solid rgba(255,255,255,0.03); box-shadow:0 12px 30px rgba(0,0,0,0.45); }
  .chart-title{ color:var(--accent); margin-bottom:10px; font-weight:700; }
  .chart-wrap{ width:100%; min-height:320px; display:flex; align-items:center; justify-content:center; }
  canvas{ width:100% !important; height:380px !important; display:block; }

  /* Analysis panel */
  .analysis-panel{ background: rgba(0,0,0,0.22); padding:14px; border-radius:10px; border-left:4px solid var(--accent2); color:var(--muted); }
  .analysis-panel h4{ margin:0 0 8px 0; color:var(--accent3); }
  .analysis-panel p{ margin:0; line-height:1.5; }

  /* Image & thumbnail */
  .img-thumb{ width:100%; height:200px; object-fit:cover; border-radius:10px; box-shadow:0 12px 30px rgba(0,0,0,0.6); }

  /* Carousel */
  .carousel{ position:relative; overflow:hidden; border-radius:12px; margin:12px 0; background:rgba(255,255,255,0.01); padding:12px; }
  .carousel-track{ display:flex; transition:transform .6s cubic-bezier(.2,.9,.3,1); will-change:transform; }
  .carousel-slide{ min-width:100%; display:flex; justify-content:center; align-items:center; padding:10px; }
  .carousel-slide img{ width:360px; height:260px; object-fit:cover; border-radius:12px; box-shadow:0 18px 40px rgba(0,0,0,0.6); }

  /* Quote carousel */
  .quote-card{ padding:12px; border-radius:12px; background:rgba(255,255,255,0.01); margin-top:10px; }
  .quote-track{ display:flex; transition:transform .6s ease; width:100%; }
  .quote-slide{ min-width:100%; box-sizing:border-box; padding:12px; opacity:0; transform:translateX(18px); transition:opacity .45s, transform .45s; }
  .quote-slide.active{ opacity:1; transform:none; }
  .quote-text{ color:var(--muted); line-height:1.6; font-size:16px; }

  /* Modal */
  .modal{ position:fixed; left:0; top:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:rgba(1,6,12,0.6); visibility:hidden; opacity:0; transition:opacity .18s; z-index:9999; }
  .modal.open{ visibility:visible; opacity:1; }
  .modal-card{ background:#07121a; padding:18px; border-radius:12px; max-width:1000px; width:94%; border:1px solid rgba(255,255,255,0.03); box-shadow:0 30px 120px rgba(0,0,0,0.7); color:var(--muted); max-height:80vh; overflow:auto; }
  .modal-close{ float:right; background:transparent; border:1px solid rgba(255,255,255,0.03); padding:6px; border-radius:8px; color:var(--muted); cursor:pointer; }

  /* Calculators & export */
  .calc-box{ background:rgba(255,255,255,0.01); padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.03); margin:10px 0; }
  .calc-box input[type="number"]{ padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:var(--text); width:110px; }
  .export-row{ display:flex; justify-content:center; margin-top:12px; }
  .export-btn{ background:var(--accent); border:none; color:#042; padding:10px 14px; border-radius:8px; font-weight:700; cursor:pointer; }

  /* Toggle */
  .toggle-container{ position:fixed; top:18px; right:18px; z-index:10000; }
  .toggle-btn{ background:var(--card); padding:8px 12px; border-radius:8px; color:var(--muted); border:1px solid rgba(255,255,255,0.02); cursor:pointer; }

  /* Animations */
  .fade-slide{ opacity:0; transform:translateY(8px); animation: fadeSlideIn 0.6s ease forwards; }
  @keyframes fadeSlideIn { to { opacity:1; transform:none; } }

  /* Responsive */
  @media(max-width:980px){
    .ss-left{ flex-basis:100%; }
    .ss-right{ flex-basis:100%; max-width:100%; }
    .carousel-slide img{ width:260px; height:180px; }
    canvas{ height:260px !important; }
  }

  /* Light mode */
  body.light-mode{ background:linear-gradient(180deg,#f7fbff 0%,#eaf8ff 100%); color:#042; }
  body.light-mode .card{ background:#ffffff; color:#042; }
  body.light-mode .analysis-panel{ background:#f6fbff; color:#042; border-left:4px solid var(--accent); }
  body.light-mode .chart-card{ background:#f7fbff; color:#042; border:1px solid rgba(4,8,12,0.03); }

  /* Force better rendering (Edge/GitHub Pages fix) */
  .chart-card, .chart-wrap { min-height: 380px; }
  </style>
</head>
<body>
  <div class="container">

    <!-- Header -->
    <header>
      <div class="header-inner">
        <div>
          <div class="brand">Cloning Survey Research Project <span style="color:var(--accent2)">™</span></div>
          <div class="signature">Site created by <strong>Arya Ravikumar</strong></div>
        </div>

        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
          <div class="toggle-container">
            <button id="modeToggle" class="toggle-btn" aria-pressed="false">Toggle Light Mode</button>
          </div>

          <div class="tabs" role="tablist" aria-label="Main navigation" style="margin-top:6px;">
            <div class="tab active" data-target="#methods">Methods</div>
            <div class="tab" data-target="#opinions">Opinions</div>
            <div class="tab" data-target="#animals">Animals</div>
            <div class="tab" data-target="#combined">Combined</div>
            <div class="tab" data-target="#humans">Human Cloning</div>
            <div class="tab" data-target="#analysis">Analysis</div>
            <div class="tab" data-target="#quotes">Quotes</div>
            <div class="tab" data-target="#calculators">Calculators</div>
          </div>
        </div>
      </div>
    </header>

    <!-- METHODS -->
    <section id="methods" class="section card fade-slide">
      <h2>Methods — Full Study Overview (Expanded)</h2>
      <div style="color:var(--muted);line-height:1.6">
        <h3>Purpose & rationale</h3>
        <p>This exploratory survey measured attitudes toward animal cloning, perceived humaneness, participants' visual identification ability for cloned vs normal animals, and opinion about expanding cloning research to humans. This project is intended for educational demonstration of survey collection, cleaning, and analysis.</p>

        <h3>Design</h3>
        <p>Within-subject classification task: participants saw 4 images in randomized order and labeled each as "Normal" or "Cloned". They also answered opinion questions.</p>

        <h3>Participants & recruitment</h3>
        <p>Convenience sample: N = 43 (high-school students). Recruited via classroom announcements and teacher supervision. Responses were anonymous and voluntary.</p>

        <h3>Materials</h3>
        <p>Place the 4 images in the same folder as this HTML file. Current paths used below (change if needed):</p>
        <ul>
          <li><code>/mnt/data/unnamed.jpg</code> (pig — Normal)</li>
          <li><code>/mnt/data/unnamed (1).jpg</code> (sheep — Cloned)</li>
          <li><code>/mnt/data/unnamed (2).jpg</code> (naur/gaur — Cloned)</li>
          <li><code>/mnt/data/unnamed (3).jpg</code> (dog — Normal)</li>
        </ul>

        <h3>Procedure</h3>
        <ol>
          <li>Consent & short intro</li>
          <li>Opinion questions (should animals be cloned? humane?)</li>
          <li>Image classification (Normal vs Cloned)</li>
          <li>Human cloning question & optional text responses</li>
        </ol>

        <h3>Data handling & analysis</h3>
        <p>Data exported to CSV, cleaned (normalize variants), aggregated. Analyses include: proportions, one-sample proportion z-tests versus 50% baseline, two-proportion z-tests, chi-square goodness-of-fit, Cohen's h effect size, and 95% CIs (normal approximation). Qualitative comments were lightly corrected for grammar and displayed in the quotes carousel.</p>

        <h3>Limitations</h3>
        <p>Small convenience sample and limited stimuli reduce generalizability. Image familiarity and framing may bias classification. Results are exploratory.</p>
      </div>
    </section>

    <!-- OPINIONS -->
    <section id="opinions" class="section card fade-slide">
      <h2>Opinion Questions</h2>

      <div class="ss-row" style="margin-bottom:18px;">
        <div class="ss-left">
          <div class="chart-card">
            <div class="chart-title">Should animals be cloned?</div>
            <div class="chart-wrap">
              <canvas id="shouldCloneChart" aria-label="chart"></canvas>
            </div>
          </div>
        </div>

        <div class="ss-right">
          <div class="analysis-panel">
            <h4>Quick interpretation</h4>
            <p id="shouldCloneText">Loading...</p>
            <div style="margin-top:10px;text-align:right;">
              <button class="export-btn" onclick="openModal('shouldCloneStats')">Detailed stats</button>
            </div>
          </div>
        </div>
      </div>

      <div class="ss-row">
        <div class="ss-left">
          <div class="chart-card">
            <div class="chart-title">Is cloning animals humane?</div>
            <div class="chart-wrap">
              <canvas id="humaneChart"></canvas>
            </div>
          </div>
        </div>

        <div class="ss-right">
          <div class="analysis-panel">
            <h4>Quick interpretation</h4>
            <p id="humaneText">Loading...</p>
            <div style="margin-top:10px;text-align:right;">
              <button class="export-btn" onclick="openModal('humaneStats')">Detailed stats</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ANIMALS (side-by-side each) -->
    <section id="animals" class="section card fade-slide">
      <h2>Individual Animal Classification</h2>

      <!-- Pig -->
      <div style="margin-bottom:18px;">
        <div class="ss-row">
          <div class="ss-left">
            <div class="chart-card">
              <div class="chart-title">Pig — actual: NORMAL</div>
              <div class="chart-wrap"><canvas id="pigChart"></canvas></div>
            </div>
          </div>

          <div class="ss-right">
            <img class="img-thumb" src="/mnt/data/unnamed.jpg" alt="Pig (Normal)">
            <div style="height:8px"></div>
            <div class="analysis-panel">
              <h4>Pig analysis</h4>
              <p id="pigText">Loading...</p>
              <div style="margin-top:8px;text-align:right;"><button class="export-btn" onclick="openModal('pigStats')">Open stats</button></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sheep -->
      <div style="margin-bottom:18px;">
        <div class="ss-row">
          <div class="ss-left">
            <div class="chart-card">
              <div class="chart-title">Sheep — actual: CLONED</div>
              <div class="chart-wrap"><canvas id="sheepChart"></canvas></div>
            </div>
          </div>

          <div class="ss-right">
            <img class="img-thumb" src="/mnt/data/unnamed (1).jpg" alt="Sheep (Cloned)">
            <div style="height:8px"></div>
            <div class="analysis-panel">
              <h4>Sheep analysis</h4>
              <p id="sheepText">Loading...</p>
              <div style="margin-top:8px;text-align:right;"><button class="export-btn" onclick="openModal('sheepStats')">Open stats</button></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gaur -->
      <div style="margin-bottom:18px;">
        <div class="ss-row">
          <div class="ss-left">
            <div class="chart-card">
              <div class="chart-title">Gaur (Naur) — actual: CLONED</div>
              <div class="chart-wrap"><canvas id="gaurChart"></canvas></div>
            </div>
          </div>

          <div class="ss-right">
            <img class="img-thumb" src="/mnt/data/unnamed (2).jpg" alt="Gaur (Cloned)">
            <div style="height:8px"></div>
            <div class="analysis-panel">
              <h4>Gaur analysis</h4>
              <p id="gaurText">Loading...</p>
              <div style="margin-top:8px;text-align:right;"><button class="export-btn" onclick="openModal('gaurStats')">Open stats</button></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Dog -->
      <div style="margin-bottom:18px;">
        <div class="ss-row">
          <div class="ss-left">
            <div class="chart-card">
              <div class="chart-title">Dog — actual: NORMAL</div>
              <div class="chart-wrap"><canvas id="dogChart"></canvas></div>
            </div>
          </div>

          <div class="ss-right">
            <img class="img-thumb" src="/mnt/data/unnamed (3).jpg" alt="Dog (Normal)">
            <div style="height:8px"></div>
            <div class="analysis-panel">
              <h4>Dog analysis</h4>
              <p id="dogText">Loading...</p>
              <div style="margin-top:8px;text-align:right;"><button class="export-btn" onclick="openModal('dogStats')">Open stats</button></div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Combined -->
    <section id="combined" class="section card fade-slide">
      <h2>Combined Results & Image Carousel</h2>

      <div class="carousel" id="animalCarousel" aria-roledescription="carousel">
        <div class="carousel-track" id="carouselTrack" style="transform:translateX(0%)">
          <div class="carousel-slide"><img src="/mnt/data/unnamed.jpg" alt="Pig"></div>
          <div class="carousel-slide"><img src="/mnt/data/unnamed (1).jpg" alt="Sheep"></div>
          <div class="carousel-slide"><img src="/mnt/data/unnamed (2).jpg" alt="Naur"></div>
          <div class="carousel-slide"><img src="/mnt/data/unnamed (3).jpg" alt="Dog"></div>
        </div>
      </div>

      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
        <button id="prevSlide" class="export-btn">◀ Prev</button>
        <button id="nextSlide" class="export-btn">Next ▶</button>
      </div>

      <div style="height:14px"></div>

      <div class="ss-row">
        <div class="ss-left">
          <div class="chart-card">
            <div class="chart-title">All Animals Combined: Normal vs Cloned</div>
            <div class="chart-wrap"><canvas id="combinedChart"></canvas></div>
          </div>
        </div>

        <div class="ss-right">
          <div class="analysis-panel">
            <h4>Combined analysis</h4>
            <p id="combinedText">Loading...</p>
            <div style="margin-top:8px;text-align:right;"><button class="export-btn" onclick="openModal('combinedStats')">Open stats</button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Human -->
    <section id="humans" class="section card fade-slide">
      <h2>Human Cloning Question</h2>

      <div class="ss-row">
        <div class="ss-left">
          <div class="chart-card">
            <div class="chart-title">Should cloning research expand to humans?</div>
            <div class="chart-wrap"><canvas id="humanChart"></canvas></div>
          </div>
        </div>

        <div class="ss-right">
          <div class="analysis-panel">
            <h4>Interpretation</h4>
            <p id="humanText">Loading...</p>
            <div style="margin-top:8px;text-align:right;"><button class="export-btn" onclick="openModal('humanStats')">Open stats</button></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Analysis -->
    <section id="analysis" class="section card fade-slide">
      <h2>Full Analysis & Recommendations</h2>
      <div style="color:var(--muted);line-height:1.6">
        <h3>Summary</h3>
        <p id="summaryText">Loading full summary...</p>

        <h3>Detailed statistical outputs (all tests)</h3>
        <pre id="analysisDetails" style="color:var(--muted); font-size:13px; white-space:pre-wrap;"></pre>

        <h3>Recommendations</h3>
        <ol>
          <li>Increase sample size and diversify participants.</li>
          <li>Include more images and vary breeds to reduce image-specific cues.</li>
          <li>Collect demographic metadata to analyze moderators.</li>
        </ol>
      </div>
    </section>

    <!-- Quotes -->
    <section id="quotes" class="section card fade-slide">
      <h2>Participant Quotes (full text - grammar lightly corrected)</h2>
      <div class="quote-card">
        <div id="quoteTrack" class="quote-track" style="transform:translateX(0%)"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:center;margin-top:8px;">
        <button id="prevQuote" class="export-btn">❮</button>
        <button id="nextQuote" class="export-btn">❯</button>
      </div>
    </section>

    <!-- Calculators -->
    <section id="calculators" class="section card fade-slide">
      <h2>Statistical Calculators</h2>

      <div class="calc-box">
        <h4>2×2 chi-square quick</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <label>a <input id="chi_a" type="number" value="10"></label>
          <label>b <input id="chi_b" type="number" value="20"></label>
          <label>c <input id="chi_c" type="number" value="30"></label>
          <label>d <input id="chi_d" type="number" value="40"></label>
        </div>
        <div style="margin-top:8px;">
          <button class="export-btn" onclick="computeChi2()">Compute χ²</button>
          <div id="chi_out" style="margin-top:8px;color:var(--muted)"></div>
        </div>
      </div>

      <div class="calc-box">
        <h4>One-sample proportion</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <label>success <input id="pz_success" type="number" value="26"></label>
          <label>n <input id="pz_n" type="number" value="43"></label>
          <label>p0 <input id="pz_p0" type="number" step="0.01" value="0.5"></label>
        </div>
        <div style="margin-top:8px;"><button class="export-btn" onclick="computePropZ()">Compute z</button><div id="pz_out" style="margin-top:8px;color:var(--muted)"></div></div>
      </div>

      <div class="calc-box">
        <h4>Two-proportion</h4>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <label>s1 <input id="tp_s1" type="number" value="26"></label>
          <label>n1 <input id="tp_n1" type="number" value="43"></label>
          <label>s2 <input id="tp_s2" type="number" value="17"></label>
          <label>n2 <input id="tp_n2" type="number" value="43"></label>
        </div>
        <div style="margin-top:8px;"><button class="export-btn" onclick="computeTwoProp()">Compute two-prop</button><div id="tp_out" style="margin-top:8px;color:var(--muted)"></div></div>
      </div>
    </section>

    <!-- Export -->
    <section class="section card fade-slide">
      <div style="display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap;">
        <button class="export-btn" onclick="exportCSV()">Export CSV</button>
        <button class="export-btn" onclick="downloadAnalysis()">Download analysis (TXT)</button>
      </div>
    </section>

    <footer style="text-align:center;margin-top:18px;color:var(--muted)">© 2025 Cloning Survey Research Project™ — Created by <strong>Arya Ravikumar</strong></footer>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-label="Statistics modal">
      <button class="modal-close" onclick="closeModal()" aria-label="Close">Close</button>
      <div id="modalContent" style="color:var(--muted);line-height:1.4"></div>
    </div>
  </div>

  <script>
  /* -------------------------
     DATA (latest update provided)
     ------------------------- */
  const DATA = {
    shouldClone: { Yes:15, No:8, Maybe:12, Unopposed:8 },
    humane: { Yes:27, No:16 },
    pig: { Normal:26, Cloned:17 },
    sheep: { Normal:10, Cloned:33 },
    gaur: { Normal:15, Cloned:28 },
    dog: { Normal:38, Cloned:5 },
    human: { Yes:17, No:26 }
  };
  DATA.combined = {
    Normal: DATA.pig.Normal + DATA.sheep.Normal + DATA.gaur.Normal + DATA.dog.Normal,
    Cloned: DATA.pig.Cloned + DATA.sheep.Cloned + DATA.gaur.Cloned + DATA.dog.Cloned
  };

  /* -------------------------
     Helpers
     ------------------------- */
  function sum(obj){ return Object.values(obj).reduce((a,b)=>a+b,0); }
  function percent(obj){ const t = sum(obj)||1; return Object.fromEntries(Object.entries(obj).map(([k,v])=>[k,((v/t)*100).toFixed(1)])); }
  function fmt(n,d=3){ return Number(n).toFixed(d); }

  // erf / normalCdf
  function erf(x){
    const sign = x>=0?1:-1; x=Math.abs(x);
    const a1=0.254829592,a2=-0.284496736,a3=1.421413741,a4=-1.453152027,a5=1.061405429; const p=0.3275911;
    const t=1/(1+p*x); const y=1 - (((((a5*t + a4)*t)+a3)*t + a2)*t + a1)*t*Math.exp(-x*x);
    return sign*y;
  }
  function normalCdf(z){ return (1 + erf(z/Math.sqrt(2))) / 2; }

  // proportion z-test
  function propZTest(successes, n, p0=0.5){
    const p = successes / n; const se = Math.sqrt(p0*(1-p0)/n);
    const z = (p - p0)/se; const pval = 2*(1 - normalCdf(Math.abs(z)));
    const seP = Math.sqrt(p*(1-p)/n); const ciLow = Math.max(0, p - 1.96*seP); const ciHigh = Math.min(1, p + 1.96*seP);
    return { z, pval, p, ci:[ciLow,ciHigh] };
  }

  // two-prop z-test
  function twoPropZ(s1,n1,s2,n2){
    const p1 = s1/n1, p2 = s2/n2; const pPool = (s1+s2)/(n1+n2);
    const se = Math.sqrt(pPool*(1-pPool)*(1/n1 + 1/n2)); const z = (p1 - p2)/se; const pval = 2*(1 - normalCdf(Math.abs(z)));
    const seDiff = Math.sqrt(p1*(1-p1)/n1 + p2*(1-p2)/n2); const diff = p1 - p2;
    const h = 2*Math.asin(Math.sqrt(p1)) - 2*Math.asin(Math.sqrt(p2));
    const ciLow = diff - 1.96*seDiff, ciHigh = diff + 1.96*seDiff;
    return { z, pval, p1, p2, diff, ci:[ciLow,ciHigh], h };
  }

  // chi-square goodness-of-fit
  function chiSquare(observed){
    const total = observed.reduce((a,b)=>a+b,0); const expected = observed.map(()=>total/observed.length);
    let chi=0; for(let i=0;i<observed.length;i++){ chi += (observed[i]-expected[i])**2 / (expected[i]||1e-9); } return chi;
  }
  function chi2pApprox(chi2){
    // approximate tail via erf transform (rough)
    const x = Math.sqrt(Math.max(0,chi2)/2); const p = 1 - erf(x); return Math.max(0, Math.min(1, p));
  }

  // Chart helper
  const palette = ['#53a7ff','#ff5894','#6aff8f','#ffe66a','#c486ff','#ffb85c'];
  function makeChart(id, type, labels, data, options={}){
    const el = document.getElementById(id);
    if(!el) return null;
    return new Chart(el, {
      type,
      data:{ labels, datasets:[{ label:'', data, backgroundColor: palette.slice(0, labels.length), borderRadius:8 }] },
      options: Object.assign({
        responsive:true,
        plugins:{ tooltip:{ callbacks:{ label: ctx => {
          const val = ctx.raw; const tot = data.reduce((a,b)=>a+b,0); const pct = tot ? ((val/tot)*100).toFixed(1) : '0.0';
          return `${ctx.label}: ${val} (${pct}%)`; } } }, legend:{ labels:{ color:'#cfeaf9' } } },
        scales:{ y:{ beginAtZero:true, ticks:{ color:'#cfeaf9' } }, x:{ ticks:{ color:'#cfeaf9' } } }
      }, options)
    });
  }

  /* -------------------------
     Initialize charts after load (fixes Edge/GitHub pages layout race)
     ------------------------- */
  window.addEventListener('load', () => {
    try{
      // opinion charts
      makeChart('shouldCloneChart','bar', Object.keys(DATA.shouldClone), Object.values(DATA.shouldClone), { scales:{ y:{ beginAtZero:true } }});
      makeChart('humaneChart','pie', Object.keys(DATA.humane), Object.values(DATA.humane));

      // per-animal
      makeChart('pigChart','pie',['Normal','Cloned'], [DATA.pig.Normal, DATA.pig.Cloned]);
      makeChart('sheepChart','pie',['Normal','Cloned'], [DATA.sheep.Normal, DATA.sheep.Cloned]);
      makeChart('gaurChart','pie',['Normal','Cloned'], [DATA.gaur.Normal, DATA.gaur.Cloned]);
      makeChart('dogChart','pie',['Normal','Cloned'], [DATA.dog.Normal, DATA.dog.Cloned]);

      // combined & human
      makeChart('combinedChart','pie',['Normal','Cloned'], [DATA.combined.Normal, DATA.combined.Cloned]);
      makeChart('humanChart','pie',['Yes','No'], [DATA.human.Yes, DATA.human.No]);

      // populate text and analysis
      populateSummaries();
      renderAnalysisDetails();

      // UI wiring
      buildQuotes(); wireQuoteButtons(); buildAnimalCarousel(); wireTabs(); wireModalClose();

      // toggle button
      document.getElementById('modeToggle').addEventListener('click', toggleMode);

      console.log('Charts initialized after load.');
    } catch(e) {
      console.error('Chart init error', e);
    }
  });

  /* -------------------------
     Populate summary texts
     ------------------------- */
  function populateSummaries(){
    document.getElementById('shouldCloneText').innerText =
      `Counts — Yes: ${DATA.shouldClone.Yes}, Maybe: ${DATA.shouldClone.Maybe}, No: ${DATA.shouldClone.No}, Unopposed: ${DATA.shouldClone.Unopposed}. Percents: ${Object.entries(percent(DATA.shouldClone)).map(([k,v])=>`${k}:${v}%`).join(', ')}`;

    document.getElementById('humaneText').innerText =
      `Counts — Yes: ${DATA.humane.Yes}, No: ${DATA.humane.No}. Percents: ${Object.entries(percent(DATA.humane)).map(([k,v])=>`${k}:${v}%`).join(', ')}`;

    document.getElementById('pigText').innerText =
      `Counts — Normal: ${DATA.pig.Normal}, Cloned: ${DATA.pig.Cloned}. Percents: ${Object.entries(percent(DATA.pig)).map(([k,v])=>`${k}:${v}%`).join(', ')}`;

    document.getElementById('sheepText').innerText =
      `Counts — Normal: ${DATA.sheep.Normal}, Cloned: ${DATA.sheep.Cloned}. Percents: ${Object.entries(percent(DATA.sheep)).map(([k,v])=>`${k}:${v}%`).join(', ')}`;

    document.getElementById('gaurText').innerText =
      `Counts — Normal: ${DATA.gaur.Normal}, Cloned: ${DATA.gaur.Cloned}. Percents: ${Object.entries(percent(DATA.gaur)).map(([k,v])=>`${k}:${v}%`).join(', ')}`;

    document.getElementById('dogText').innerText =
      `Counts — Normal: ${DATA.dog.Normal}, Cloned: ${DATA.dog.Cloned}. Percents: ${Object.entries(percent(DATA.dog)).map(([k,v])=>`${k}:${v}%`).join(', ')}`;

    document.getElementById('combinedText').innerText =
      `Combined totals — Normal: ${DATA.combined.Normal}, Cloned: ${DATA.combined.Cloned}. Percents: ${Object.entries(percent(DATA.combined)).map(([k,v])=>`${k}:${v}%`).join(', ')}`;

    document.getElementById('humanText').innerText =
      `Counts — Yes: ${DATA.human.Yes}, No: ${DATA.human.No}. Percents: ${Object.entries(percent(DATA.human)).map(([k,v])=>`${k}:${v}%`).join(', ')}`;

    document.getElementById('summaryText').innerText =
      `N = ${sum(DATA.shouldClone)} participants. Findings: conditional support for animal cloning (plurality Yes but many Maybe), strong cloned attribution for sheep & gaur, high correct normal labeling for dog & pig, and majority opposing expansion to humans. See detailed stats below.`;
  }

  /* -------------------------
     Detailed analysis rendering
     ------------------------- */
  function renderAnalysisDetails(){
    let out = '';
    // shouldClone
    const obsClone = Object.values(DATA.shouldClone); const nClone = sum(DATA.shouldClone);
    const chiClone = chiSquare(obsClone); const pChiClone = chi2pApprox(chiClone);
    out += `Should animals be cloned?\\nCounts: ${Object.entries(DATA.shouldClone).map(([k,v])=>`${k}:${v}`).join(', ')} (N=${nClone})\\n`;
    out += `Chi-square (gof) = ${fmt(chiClone,4)} ; approx p ≈ ${pChiClone.toFixed(6)}\\n\\n`;

    // humane
    const nHum = sum(DATA.humane), resHum = propZTest(DATA.humane.Yes, nHum);
    out += `Is cloning animals humane?\\nCounts: Yes:${DATA.humane.Yes}, No:${DATA.humane.No} (N=${nHum})\\n`;
    out += `One-sample prop test (Yes vs 0.5): observed p=${(resHum.p*100).toFixed(1)}% ; z=${fmt(resHum.z,3)} ; p=${fmt(resHum.pval,6)} ; 95% CI: [${(resHum.ci[0]*100).toFixed(1)}%, ${(resHum.ci[1]*100).toFixed(1)}%]\\n\\n`;

    // per-animal
    ['pig','sheep','gaur','dog'].forEach(a=>{
      const counts = DATA[a]; const n = sum(counts);
      const majKey = counts.Normal >= counts.Cloned ? 'Normal' : 'Cloned';
      const succ = majKey === 'Normal' ? counts.Normal : counts.Cloned;
      const r = propZTest(succ, n);
      out += `${a.toUpperCase()} — Counts: Normal:${counts.Normal}, Cloned:${counts.Cloned} (N=${n})\\n`;
      out += `Majority: ${majKey} (${(r.p*100).toFixed(1)}%) ; z=${fmt(r.z,3)} ; p=${fmt(r.pval,6)} ; 95% CI: [${(r.ci[0]*100).toFixed(1)}%, ${(r.ci[1]*100).toFixed(1)}%]\\n\\n`;
    });

    // combined
    const nCombined = DATA.combined.Normal + DATA.combined.Cloned;
    const two = twoPropZ(DATA.combined.Normal, nCombined, DATA.combined.Cloned, nCombined);
    out += `Combined — Normal:${DATA.combined.Normal}, Cloned:${DATA.combined.Cloned} (N=${nCombined})\\n`;
    out += `Two-prop: diff=${fmt(two.diff,4)} ; z=${fmt(two.z,3)} ; p=${fmt(two.pval,6)} ; 95% CI: [${fmt(two.ci[0],4)}, ${fmt(two.ci[1],4)}] ; Cohen's h=${fmt(two.h,4)}\\n\\n`;

    // human
    const nHuman = sum(DATA.human), rh = propZTest(DATA.human.No, nHuman);
    out += `Human cloning expansion — Yes:${DATA.human.Yes}, No:${DATA.human.No} (N=${nHuman})\\n`;
    out += `One-sample prop (No vs 0.5): observed p=${(rh.p*100).toFixed(1)}% ; z=${fmt(rh.z,3)} ; p=${fmt(rh.pval,6)} ; 95% CI: [${(rh.ci[0]*100).toFixed(1)}%, ${(rh.ci[1]*100).toFixed(1)}%]\\n\\n`;

    document.getElementById('analysisDetails').innerText = out;
  }

  /* -------------------------
     Quotes carousel
     ------------------------- */
  const QUOTES = [
    "You have to consider the reasons why cloning is done. If it’s to save an endangered species, then sure. But if it’s to help the market — cloning animals just to kill them off for profit — that’s wrong. Depending on the intent and the policies/regulations in place, its morality can be debated. The purpose also matters for humans, along with who gets to decide the regulations and rights to do so, assuming it would be safe in the first place.",
    "Cloning for parts is inhumane because the clone — which is also a living organism — is not given a fair chance to live compared to naturally birthed organisms. But for restoration causes, cloning can be a valuable tool in my opinion.",
    "Not necessarily animals, unless they can’t feel — then we could have mindless animals and killing them would be more morally justifiable.",
    "It’s not ethical to clone animals if it is hurting them in any way, shape, or form. The main reason people clone is often to use parts from the clone, which I view as immoral.",
    "Cloning animals could be helpful for assisting endangered species or in very special circumstances.",
    "Cloning humans can lead to detrimental outcomes such as ethnic cleansing and genetic mutations."
  ];
  let qIndex = 0;
  function buildQuotes(){
    const track = document.getElementById('quoteTrack'); if(!track) return;
    track.innerHTML = '';
    QUOTES.forEach((q,i)=>{ const div=document.createElement('div'); div.className='quote-slide'+(i===0?' active':''); div.innerHTML=`<div class="quote-text">${q}</div>`; track.appendChild(div); });
    setInterval(()=>{ qIndex=(qIndex+1)%QUOTES.length; updateQuotes(); },7000);
    track.addEventListener('touchstart', e=> track._startX = e.touches[0].clientX);
    track.addEventListener('touchend', e=>{ const end=e.changedTouches[0].clientX; if(track._startX-end>50){ qIndex=(qIndex+1)%QUOTES.length; updateQuotes(); } if(end-track._startX>50){ qIndex=(qIndex-1+QUOTES.length)%QUOTES.length; updateQuotes(); } });
  }
  function updateQuotes(){ const slides=document.querySelectorAll('.quote-slide'); slides.forEach((s,i)=> s.classList.toggle('active', i===qIndex)); const track=document.getElementById('quoteTrack'); if(track) track.style.transform=`translateX(-${qIndex*100}%)`; }
  function wireQuoteButtons(){ document.getElementById('nextQuote').addEventListener('click', ()=>{ qIndex=(qIndex+1)%QUOTES.length; updateQuotes(); }); document.getElementById('prevQuote').addEventListener('click', ()=>{ qIndex=(qIndex-1+QUOTES.length)%QUOTES.length; updateQuotes(); }); }

  /* -------------------------
     Animal image carousel
     ------------------------- */
  function buildAnimalCarousel(){
    const track = document.getElementById('carouselTrack'); if(!track) return;
    let slide=0; const total = track.children.length;
    function setTrack(){ track.style.transform = `translateX(-${slide*100}%)`; }
    window.nextSlide = ()=> { slide = (slide+1) % total; setTrack(); };
    window.prevSlide = ()=> { slide = (slide-1+total) % total; setTrack(); };
    document.getElementById('nextSlide').addEventListener('click', ()=> nextSlide());
    document.getElementById('prevSlide').addEventListener('click', ()=> prevSlide());
    const carousel = document.getElementById('animalCarousel');
    if(carousel){ carousel.addEventListener('touchstart', e=> carousel._startX = e.touches[0].clientX); carousel.addEventListener('touchend', e=>{ const end=e.changedTouches[0].clientX; if(carousel._startX-end>50) nextSlide(); if(end-carousel._startX>50) prevSlide(); }); }
    setInterval(()=> nextSlide(),4200);
  }

  /* -------------------------
     Tabs
     ------------------------- */
  function wireTabs(){ document.querySelectorAll('.tab').forEach(tab=>{ tab.addEventListener('click', ()=>{ document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); tab.classList.add('active'); const target = document.querySelector(tab.dataset.target); if(target) target.scrollIntoView({behavior:'smooth', block:'start'}); }); }); }

  /* -------------------------
     Modal & stats details
     ------------------------- */
  const modal = document.getElementById('modal'); const modalContent = document.getElementById('modalContent');
  function openModal(key){ if(!modal) return; modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); modalContent.innerHTML = renderStatsModal(key); modalContent.scrollTop = 0; }
  function closeModal(){ if(!modal) return; modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); modalContent.innerHTML=''; }
  function wireModalClose(){ const close = document.querySelector('.modal-close'); if(close) close.addEventListener('click', closeModal); if(modal) modal.addEventListener('click', (e)=>{ if(e.target === modal) closeModal(); }); }

  function renderStatsModal(key){
    if(key==='shouldCloneStats'){ const n = sum(DATA.shouldClone), chi = chiSquare(Object.values(DATA.shouldClone)), pchi = chi2pApprox(chi); return `<h3>Should animals be cloned? — Stats</h3><p>Counts: ${Object.entries(DATA.shouldClone).map(([k,v])=>`${k}:${v}`).join(', ')} (N=${n})</p><p>Chi² = ${fmt(chi,4)}, approx p = ${pchi.toFixed(6)}</p><p>Interpretation: plurality for Yes but many conditional responses indicate opinions depend on scenario.</p>`; }
    if(key==='humaneStats'){ const n=sum(DATA.humane), r=propZTest(DATA.humane.Yes,n); return `<h3>Is cloning humane? — Stats</h3><p>Yes:${DATA.humane.Yes}, No:${DATA.humane.No} (N=${n})</p><p>p_obs=${(r.p*100).toFixed(1)}% ; z=${fmt(r.z,3)} ; p=${fmt(r.pval,6)} ; 95% CI: [${(r.ci[0]*100).toFixed(1)}%, ${(r.ci[1]*100).toFixed(1)}%]</p>`; }
    if(key==='pigStats'){ const n=sum(DATA.pig), r=propZTest(DATA.pig.Normal,n); return `<h3>Pig — Stats</h3><p>Normal:${DATA.pig.Normal}, Cloned:${DATA.pig.Cloned} (N=${n})</p><p>p=${(r.p*100).toFixed(1)}% ; z=${fmt(r.z,3)} ; p=${fmt(r.pval,6)} ; 95% CI: [${(r.ci[0]*100).toFixed(1)}%, ${(r.ci[1]*100).toFixed(1)}%]</p>`; }
    if(key==='sheepStats'){ const n=sum(DATA.sheep), r=propZTest(DATA.sheep.Cloned,n); return `<h3>Sheep — Stats</h3><p>Normal:${DATA.sheep.Normal}, Cloned:${DATA.sheep.Cloned} (N=${n})</p><p>p=${(r.p*100).toFixed(1)}% ; z=${fmt(r.z,3)} ; p=${fmt(r.pval,6)} ; 95% CI: [${(r.ci[0]*100).toFixed(1)}%, ${(r.ci[1]*100).toFixed(1)}%]</p>`; }
    if(key==='gaurStats'){ const n=sum(DATA.gaur), r=propZTest(DATA.gaur.Cloned,n); return `<h3>Gaur — Stats</h3><p>Normal:${DATA.gaur.Normal}, Cloned:${DATA.gaur.Cloned} (N=${n})</p><p>p=${(r.p*100).toFixed(1)}% ; z=${fmt(r.z,3)} ; p=${fmt(r.pval,6)} ; 95% CI: [${(r.ci[0]*100).toFixed(1)}%, ${(r.ci[1]*100).toFixed(1)}%]</p>`; }
    if(key==='dogStats'){ const n=sum(DATA.dog), r=propZTest(DATA.dog.Normal,n); return `<h3>Dog — Stats</h3><p>Normal:${DATA.dog.Normal}, Cloned:${DATA.dog.Cloned} (N=${n})</p><p>p=${(r.p*100).toFixed(1)}% ; z=${fmt(r.z,3)} ; p=${fmt(r.pval,6)} ; 95% CI: [${(r.ci[0]*100).toFixed(1)}%, ${(r.ci[1]*100).toFixed(1)}%]</p>`; }
    if(key==='combinedStats'){ const n = DATA.combined.Normal + DATA.combined.Cloned, two = twoPropZ(DATA.combined.Normal,n,DATA.combined.Cloned,n); return `<h3>Combined — Stats</h3><p>Normal:${DATA.combined.Normal}, Cloned:${DATA.combined.Cloned} (N=${n})</p><p>diff=${fmt(two.diff,4)}, z=${fmt(two.z,3)}, p=${fmt(two.pval,6)} ; 95% CI: [${fmt(two.ci[0],4)}, ${fmt(two.ci[1],4)}] ; Cohen's h=${fmt(two.h,4)}</p>`; }
    if(key==='humanStats'){ const n=sum(DATA.human), r=propZTest(DATA.human.No,n); return `<h3>Human cloning — Stats</h3><p>Yes:${DATA.human.Yes}, No:${DATA.human.No} (N=${n})</p><p>Observed No p=${(r.p*100).toFixed(1)}% ; z=${fmt(r.z,3)} ; p=${fmt(r.pval,6)} ; 95% CI: [${(r.ci[0]*100).toFixed(1)}%, ${(r.ci[1]*100).toFixed(1)}%]</p>`; }
    return `<pre>No stats for ${key}</pre>`;
  }

  /* -------------------------
     Export & download
     ------------------------- */
  function exportCSV(){
    const rows = [['Question','Option','Count'],
      ['Should animals be cloned?','Yes',DATA.shouldClone.Yes],
      ['Should animals be cloned?','Maybe',DATA.shouldClone.Maybe],
      ['Should animals be cloned?','No',DATA.shouldClone.No],
      ['Should animals be cloned?','Unopposed',DATA.shouldClone.Unopposed],
      ['Is cloning humane?','Yes',DATA.humane.Yes], ['Is cloning humane?','No',DATA.humane.No],
      ['Pig','Normal',DATA.pig.Normal], ['Pig','Cloned',DATA.pig.Cloned],
      ['Sheep','Normal',DATA.sheep.Normal], ['Sheep','Cloned',DATA.sheep.Cloned],
      ['Gaur','Normal',DATA.gaur.Normal], ['Gaur','Cloned',DATA.gaur.Cloned],
      ['Dog','Normal',DATA.dog.Normal], ['Dog','Cloned',DATA.dog.Cloned],
      ['Human cloning','Yes',DATA.human.Yes], ['Human cloning','No',DATA.human.No]
    ];
    const csv = rows.map(r=> r.map(c=> `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type:'text/csv' }); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'cloning_survey_export.csv'; a.click(); URL.revokeObjectURL(url);
  }

  function downloadAnalysis(){
    const text = `Cloning Survey Analysis - Arya Ravikumar (2025)\\n\\nSummary:\\n${document.getElementById('summaryText').innerText}\\n\\nDetailed:\\n${document.getElementById('analysisDetails').innerText}`;
    const blob = new Blob([text], { type:'text/plain' }); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'cloning_analysis.txt'; a.click(); URL.revokeObjectURL(url);
  }

  /* -------------------------
     Calculators
     ------------------------- */
  function computeChi2(){
    const a = Number(document.getElementById('chi_a').value||0), b = Number(document.getElementById('chi_b').value||0);
    const c = Number(document.getElementById('chi_c').value||0), d = Number(document.getElementById('chi_d').value||0);
    const total = a+b+c+d; if(total===0){ document.getElementById('chi_out').innerText='Enter positive numbers'; return; }
    const row1 = a+b, row2 = c+d, col1 = a+c, col2 = b+d;
    const expA = row1*col1/total, expB = row1*col2/total, expC = row2*col1/total, expD = row2*col2/total;
    const chi = (a-expA)**2/(expA||1e-9) + (b-expB)**2/(expB||1e-9) + (c-expC)**2/(expC||1e-9) + (d-expD)**2/(expD||1e-9);
    const p = chi2pApprox(chi);
    document.getElementById('chi_out').innerText = `χ² ≈ ${chi.toFixed(4)} ; approx p ≈ ${p.toFixed(4)}`;
  }

  function computePropZ(){
    const s = Number(document.getElementById('pz_success').value||0), n = Number(document.getElementById('pz_n').value||1), p0 = Number(document.getElementById('pz_p0').value||0.5);
    if(n<=0){ document.getElementById('pz_out').innerText='n must be > 0'; return; }
    const r = propZTest(s,n,p0); document.getElementById('pz_out').innerText = `p=${(r.p*100).toFixed(1)}% ; z=${fmt(r.z,3)} ; p=${fmt(r.pval,6)} ; 95% CI: [${(r.ci[0]*100).toFixed(1)}%, ${(r.ci[1]*100).toFixed(1)}%]`;
  }

  function computeTwoProp(){
    const s1 = Number(document.getElementById('tp_s1').value||0), n1 = Number(document.getElementById('tp_n1').value||1);
    const s2 = Number(document.getElementById('tp_s2').value||0), n2 = Number(document.getElementById('tp_n2').value||1);
    if(n1<=0||n2<=0){ document.getElementById('tp_out').innerText='n1,n2 must be > 0'; return; }
    const r = twoPropZ(s1,n1,s2,n2); document.getElementById('tp_out').innerText = `p1=${(r.p1*100).toFixed(1)}%, p2=${(r.p2*100).toFixed(1)}% ; diff=${(r.diff*100).toFixed(2)}% ; z=${fmt(r.z,3)} ; p=${fmt(r.pval,6)} ; 95% CI: [${(r.ci[0]*100).toFixed(2)}%, ${(r.ci[1]*100).toFixed(2)}%] ; Cohen's h=${fmt(r.h,4)}`;
  }

  /* -------------------------
     Toggle
     ------------------------- */
  function toggleMode(){ document.body.classList.toggle('light-mode'); const btn = document.getElementById('modeToggle'); const on = document.body.classList.contains('light-mode'); btn.setAttribute('aria-pressed', on?'true':'false'); btn.innerText = on ? 'Light Mode' : 'Toggle Light Mode'; }

  /* -------------------------
     UI wiring after DOM loaded
     ------------------------- */
  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      document.getElementById('prevQuote').addEventListener('click', ()=>{ qIndex=(qIndex-1+QUOTES.length)%QUOTES.length; updateQuotes(); });
      document.getElementById('nextQuote').addEventListener('click', ()=>{ qIndex=(qIndex+1)%QUOTES.length; updateQuotes(); });
      document.getElementById('prevSlide').addEventListener('click', ()=> window.prevSlide && window.prevSlide());
      document.getElementById('nextSlide').addEventListener('click', ()=> window.nextSlide && window.nextSlide());
      wireTabs(); wireModalClose();
    } catch(e){ console.warn('UI wire error', e); }
  });
  </script>
</body>
</html>
